variables:
  SONAR_USER_HOME: '${CI_PROJECT_DIR}/.sonar' # Defines the location of the analysis task cache
  GIT_DEPTH: 0 # Tells git to fetch all the branches of the project, required by the analysis task
cache:
  key: ${CI_JOB_NAME}
  paths:
    - .sonar/cache

sonarqube-check:
  stage: test
  image:
    name: sonarsource/sonar-scanner-cli:latest
  before_script:
    - echo "===========Start Sonar Scanner============="
    - if [ "$PROJECT_NAME" == "" ];
      then
      export PROJECT_NAME=$SERVICE_NAME;
      else
      echo "$PROJECT_NAME";
      fi
  script:
    - npm install typescript-compiler
    - npm install -g typescript
    - set NODE_PATH=/home/node/.npm-global/bin
    - sonar-scanner -Dsonar.qualitygate.wait=true -Dsonar.projectKey=$PROJECT_NAME -Dsonar.projectVersion="${CI_COMMIT_REF_NAME} ($CI_COMMIT_SHORT_SHA) [${CI_JOB_ID}]" -Dproject.settings=./sonarqube.analysis.properties -Dsonar.sources=.
  allow_failure: true
